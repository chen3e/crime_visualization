<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CrimeMapper</title>
    <base href="/">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon" href="assets/img/crimeMapperIcon.png">
</head>
<body>
    <app-root></app-root>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Google maps JS -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt7vqsxxzPKE6DPsHGF59JZfBZ-BOYBb0&libraries=visualization"
    async defer></script>

    <script>
        let crimes = [];

        var map;
        // This function is the callback defined in script url callback= parameter. MUST MATCH
        var map, heatmap;
        function initMap() {
            var chicago = { lat: 41.8974, lng: -87.6352 };
            var heatmapData = [
                // { location: new google.maps.LatLng(41.897, -87.635), weight: 1000 },
                // { location: new google.maps.LatLng(41.897, -87.637), weight: 1000 },
                // { location: new google.maps.LatLng(41.897, -87.639), weight: 1000 },
                // { location: new google.maps.LatLng(41.897, -87.641), weight: 1000 },
                // { location: new google.maps.LatLng(41.890, -87.637), weight: 1000 },
                // { location: new google.maps.LatLng(41.890, -87.638), weight: 1000 },
                // { location: new google.maps.LatLng(41.890, -87.630), weight: 1000 },
                // { location: new google.maps.LatLng(41.890, -87.632), weight: 1000 },
                // { location: new google.maps.LatLng(41.890, -87.633), weight: 1000 },
            ];
            for (let i = 0; i < crimes.length; i++) {
                heatmapData.push({ location: new google.maps.LatLng(Number(crimes[i].latitude), Number(crimes[i].longitude)), weight: 1000 });
            }
            console.log(heatmapData)
            map = new google.maps.Map(document.getElementById('map'), {
                center: chicago,
                zoom: 16
            });
            var marker = new google.maps.Marker({ position: chicago, map: map });
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map
            });
        }
        function toggleHeatmap() {
            heatmap.setMap(heatmap.getMap() ? null : map);
        }
        function changeGradient() {
            var gradient = [
                'rgba(0, 255, 255, 0)',
                'rgba(0, 255, 255, 1)',
                'rgba(0, 191, 255, 1)',
                'rgba(0, 127, 255, 1)',
                'rgba(0, 63, 255, 1)',
                'rgba(0, 0, 255, 1)',
                'rgba(0, 0, 223, 1)',
                'rgba(0, 0, 191, 1)',
                'rgba(0, 0, 159, 1)',
                'rgba(0, 0, 127, 1)',
                'rgba(63, 0, 91, 1)',
                'rgba(127, 0, 63, 1)',
                'rgba(191, 0, 31, 1)',
                'rgba(255, 0, 0, 1)'
            ]
            heatmap.set('gradient', heatmap.get('gradient') ? null : gradient);
        }
        function changeRadius() {
            heatmap.set('radius', heatmap.get('radius') ? null : 20);
        }
        function changeOpacity() {
            heatmap.set('opacity', heatmap.get('opacity') ? null : 0.2);
        }

        $(document).ready(function () {
            $.ajax({
                url: "https://yourmapper2.p.mashape.com/markers?center=0&f=json&id=182&lat=41.881&lon=-87.623&num=500&start=2015-11-22&end=2015-11-22",
                headers: { "X-Mashape-Key": "rSCiGbEc2amshYK4i3bGFu9ltLZWp1D9W11jsnoxBKLY0ixRyW", "Accept": "application/json" },
                type: "GET",
                success: function (data) {
                    crimes = JSON.parse(data)['items'];
                    console.log(crimes);
                    initMap();
                }
            });
            console.log("READY!!!!")

            $("#searchBar").hide();
            let showSearch = false;
            $("#showSearch").click(function () {
                $("#searchBar").slideToggle();
                if (!showSearch) {
                    $(this).html("Hide Search")
                    showSearch = true;
                }
                else {
                    $(this).html("Filter Results");
                    showSearch = false;
                }
            })

            $("#searchForm").submit(function() {
                let searchParams = {
                    keyword: $('#keyword').val(),
                    categoryid: [],
                    end_date: $('#end_date').val() || '2015-11-22',
                    lat: 41.881,
                    lon: -87.623,
                    start_date: $('#start_date').val() || '2015-11-22'
                }
                console.log(searchParams.categoryid);

                if (searchParams.start_date) {
                    searchParams.start_date = new Date(searchParams.start_date).toISOString();
                }
                if (searchParams.end_date) {
                    searchParams.end_date = new Date(searchParams.end_date).toISOString();
                }

                $('#categoryid').children(':selected').each(function() {
                    searchParams.categoryid.push($(this).val().split(":")[1].split("'")[1]);
                })

                searchParams.categoryid = searchParams.categoryid.join(",");
                console.log(searchParams);

                $.ajax({
                    url: `https://yourmapper2.p.mashape.com/markers?c=${searchParams.categoryid}&center=0&end=${searchParams.end_date}&f=json&id=182&lat=${searchParams.lat}&lon=${searchParams.lon}&num=500&search=${searchParams.keyword}&start=${searchParams.start_date}`,
                    headers: { "X-Mashape-Key": "rSCiGbEc2amshYK4i3bGFu9ltLZWp1D9W11jsnoxBKLY0ixRyW", "Accept": "application/json" },
                    type: "GET",
                    success: function (data) {
                        console.log(data);
                        crimes = JSON.parse(data)['items'];
                        console.log(crimes);
                        initMap();
                    }
                });
            })
        });
    </script>
</body>
</html>